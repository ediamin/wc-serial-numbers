jQuery(document).ready(function(n){var d={modal:null,init:function(){n(document.body).on("wc_backbone_modal_loaded",this.backbone.init).on("wcsn_backbone_modal_response",this.backbone.response),n(document).ajaxSend(this.filter_sn_products),n(document).ajaxSend(this.close_add_products_modal),n(document).ajaxComplete(this.may_be_refresh_serial_numbers)},block:function(e){e.block({message:null,overlayCSS:{background:"#fff",opacity:.6}})},unblock:function(e){e.unblock()},backbone:{init:function(e,o){"wcsn-modal-add-products"===o&&n(document.body).trigger("wc_backbone_modal_loaded","wc-modal-add-products")},response:function(e,o){d.modal=o;var t=n(this).find("table.widefat").find("tbody").find("tr"),a={};if(n(t).each(function(){var e=n(this).find(':input[name="item_id"]').val(),o=n(this).find(':input[name="item_qty"]').val()||1;e&&(a[e]||(a[e]=0),a[e]+=o)}),!Object.keys(a).length)return o.closeButton(e),alert(wc_serial_numbers_meta_boxes_order_i10n.i18n.no_product_selected);d.backbone.validate_items(a)},validate_items:function(e){var o=n("#wcsn-modal-add-products > .wc-backbone-modal-content");d.block(o),n.ajax({url:woocommerce_admin_meta_boxes.ajax_url,method:"post",data:{action:"wcsn_validate_add_order_items",security:woocommerce_admin_meta_boxes.order_item_nonce,items:e}}).done(function(e){if(!e.success&&e.data)return alert(e.data);n(document.body).trigger("wc_backbone_modal_response",["wc-modal-add-products"])}).fail(function(){alert(wc_serial_numbers_meta_boxes_order_i10n.i18n.something_went_wrong)}).always(function(){d.unblock(o)})}},refresh_serial_numbers:function(){var o=n("#wcsn-admin-order-serial-numbers");d.block(o),n.ajax({type:"get",url:woocommerce_admin_meta_boxes.ajax_url,dataType:"json",data:{action:"wcsn_get_order_metabox_table_items",security:woocommerce_admin_meta_boxes.order_item_nonce,order_id:woocommerce_admin_meta_boxes.post_id}}).done(function(e){e.success&&e.data&&e.data.tbody&&o.children("tbody").html(e.data.tbody),d.unblock(o)})},filter_sn_products:function(e,o,t){t.url&&"string"==typeof t.url&&0<=t.url.indexOf("action=wcsn_json_search_products_and_variations")&&n("#wcsn-modal-add-products-chkbox").is(":checked")&&(t.url+="&wcsn_product_only=true")},close_add_products_modal:function(e,o,t){t.data&&"string"==typeof t.data&&0<=t.data.indexOf("action=woocommerce_add_order_item")&&d.modal&&(d.modal.closeButton(new Event("")),d.modal=null)},may_be_refresh_serial_numbers:function(e,o,t){t.data&&"string"==typeof t.data&&(0<=t.data.indexOf("action=woocommerce_add_order_item")&&d.refresh_serial_numbers(),0<=t.data.indexOf("action=woocommerce_remove_order_item")&&d.refresh_serial_numbers("remove_item"))}},o=n.extend({},n.WCBackboneModal.View.prototype),e=n.extend(n.WCBackboneModal.View.prototype,{initialize:function(e){return"wc-modal-add-products"===e.target&&(e.target="wcsn-modal-add-products"),o.initialize.call(this,e)},addButton:function(e){"wcsn-modal-add-products"===this._target?n(document.body).trigger("wcsn_backbone_modal_response",[this]):(n(document.body).trigger("wc_backbone_modal_response",[this._target,this.getFormData()]),this.closeButton(e))}});n.WCBackboneModal.View=n.WCBackboneModal.View.extend(e),d.init()});